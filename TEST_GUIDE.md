# 5,000원 소액 테스트 가이드

## ⚠️ 수정된 알고리즘 개선사항

### 1. ATR을 레짐 판별에 통합 ✅
- ADX가 낮아도 ATR이 급증하면 → UNKNOWN (레인지 붕괴 감지)
- 중간 ADX 구간에서 ATR 확장되면 → 약한 추세로 전환
- 안정적인 레인지만 거래 허용

### 2. NaN/분모=0 방어 강화 ✅
- RSI 계산에서 avg_loss=0 처리
- BB position 계산에서 band_width=0 처리
- ADX 계산에서 ATR=0, DI_sum=0 처리
- None 값 체크 추가

### 3. 변동성 필터 추가 ✅
- **BB 폭 최소값**: 1% 미만이면 거래 중단 (스퀴즈 회피)
- **BB 폭 최대값**: 10% 초과면 거래 중단 (브레이크아웃 회피)
- **쿨다운**: 거래 후 5분간 재진입 금지

### 4. 중간 ADX 로직 개선 ✅
- ATR 확장 시 약한 추세로 판단
- MA 바이어스로 방향 결정

---

## 🧪 테스트 전 준비

### 1단계: API 키 발급
1. Upbit 로그인 → 고객센터 → Open API 관리
2. **권한 설정**:
   - ✅ 자산 조회
   - ✅ 주문 조회
   - ✅ 주문하기
   - ❌ 출금하기 (보안상 비활성화)
3. IP 주소 등록 (보안 강화 권장)

### 2단계: 환경 설정
```bash
# 테스트 설정 파일을 .env로 복사
cp .env.test_small .env

# .env 파일 수정 (API 키 입력)
nano .env  # 또는 원하는 편집기 사용
```

**`.env` 파일에서 수정할 부분**:
```bash
UPBIT_API_KEY=여기에_실제_API_키_입력
UPBIT_API_SECRET=여기에_실제_시크릿_입력
```

### 3단계: 계좌에 5,000원 입금
- 업비트 앱/웹 → 입금 → 원화 입금
- 정확히 5,000원 이상 입금 (수수료 고려)

---

## 🚀 테스트 실행

### 실행 명령어
```bash
# 봇 실행
python3 -m src.app.main
```

### 예상 로그
```
2025-01-06 12:00:00 - INFO - 🚀 Trading bot starting...
2025-01-06 12:00:01 - INFO - Account initialized: Balance=5,000
2025-01-06 12:00:01 - INFO - Entering main loop (interval: 60s)
2025-01-06 12:00:02 - INFO - === Loop iteration started ===
2025-01-06 12:00:02 - INFO - Processing 1 symbols...
2025-01-06 12:00:02 - INFO - Processing BTC/KRW...
2025-01-06 12:00:03 - DEBUG - Fetched 200 candles
2025-01-06 12:00:03 - DEBUG - Regime: RANGING (ADX=17.72 < 20, ATR stable)
2025-01-06 12:00:03 - DEBUG - BB too narrow (0.85% < 1.0%), range may break
2025-01-06 12:00:03 - INFO - === Loop iteration completed ===
```

---

## 📊 거래 시나리오

### 시나리오 1: 매수 → 익절 (성공)
1. **진입**: 가격 < BB 하단 AND RSI < 30
   - 예: BTC 50,000,000원 → 49,800,000원 급락
   - 5,000원 전액으로 매수
2. **청산**: 가격 ≥ BB 중간선 OR RSI > 50
   - 예: 50,100,000원 회귀 → 익절
   - **수익**: 약 +30원 (0.6% 상승)

### 시나리오 2: 매수 → 손절 (손실)
1. **진입**: 가격 < BB 하단 AND RSI < 30
2. **청산**: 가격이 ATR x 2만큼 하락 (손절)
   - **손실**: 약 -50원 (1% 손실)
3. **보호**: 연속 2번 손실 시 자동 중단

### 시나리오 3: 필터 작동 (거래 안 함)
- **BB 폭 좁음**: "BB too narrow (0.8%)" → 스퀴즈, 거래 안 함
- **BB 폭 넓음**: "BB too wide (12%)" → 브레이크아웃, 거래 안 함
- **쿨다운**: "Cooldown active: 180s / 300s" → 5분 대기
- **ATR 급증**: "Regime: UNKNOWN (ATR spike 2.1x)" → 거래 안 함

---

## ⚙️ 안전장치

### 리스크 제한
| 항목 | 제한 | 설명 |
|------|------|------|
| **거래당 리스크** | 1% | 한 번에 최대 50원 손실 |
| **일일 손실 한도** | 2% | 하루 최대 100원 손실 |
| **연속 손실** | 2회 | 2번 연속 손실 시 중단 |
| **최대 낙폭** | 5% | 누적 250원 손실 시 중단 |
| **쿨다운** | 5분 | 거래 후 5분간 재진입 금지 |

### 자동 중단 조건
```python
# 다음 조건 중 하나라도 충족되면 자동 중단:
if account.daily_loss >= 100원:      # 하루 손실 2%
    halt("Daily loss limit")
if account.consecutive_losses >= 2:  # 연속 2회 손실
    halt("Consecutive losses")
if account.drawdown >= 250원:        # 누적 낙폭 5%
    halt("Max drawdown")
```

---

## 🛑 중단 방법

### 정상 종료
```bash
# 터미널에서
Ctrl + C  # 한 번만 누르기
```
- 현재 루프 완료 후 안전하게 종료
- **포지션 보존**: 열린 포지션 유지됨

### 긴급 종료
```bash
# 터미널에서
Ctrl + C (2번 연속)  # 또는 Ctrl + Z
```
- 즉시 프로세스 종료
- ⚠️ 주의: 진행 중인 주문이 있을 수 있음

### 포지션 수동 청산
업비트 앱/웹에서 수동으로 매도 가능

---

## 📈 결과 확인

### 1. 실시간 로그 (터미널)
```bash
# 거래 신호
2025-01-06 12:05:00 - INFO - LONG signal generated: Mean reversion LONG: price=49800000 < BB_lower=49850000, RSI=28.5 < 30, BBW=2.5%

# 주문 실행
2025-01-06 12:05:01 - INFO - Order created: buy 0.0001 BTC/KRW @ market

# 포지션 열림
2025-01-06 12:05:02 - INFO - Position opened: BTC/KRW buy 0.0001 @ 49800000

# 익절
2025-01-06 12:07:00 - INFO - LONG exit: price=50100000 >= BB_middle=50000000
2025-01-06 12:07:01 - INFO - Position closed: BTC/KRW (PnL: +30.00)
```

### 2. CSV 로그 (파일)
```bash
# 로그 파일 위치
logs/trades_20250106.csv
logs/positions_20250106.csv
logs/signals_20250106.csv

# 확인
cat logs/trades_20250106.csv
```

### 3. 업비트 거래 내역
- 업비트 앱/웹 → 거래내역
- 실제 주문 상태 확인

---

## 🔍 트러블슈팅

### 문제 1: "Insufficient balance"
**원인**: 계좌 잔액 부족
**해결**: 5,000원 이상 입금 확인

### 문제 2: "Invalid API key"
**원인**: API 키가 잘못됨
**해결**: `.env` 파일의 키 확인 (공백 없이 정확히 입력)

### 문제 3: "Rate limit exceeded"
**원인**: API 호출 제한
**해결**: 1분 대기 후 재실행 (CCXT가 자동 제한)

### 문제 4: 거래가 안 일어남
**원인**: 진입 조건 미충족
**확인**:
- Regime이 RANGING인가?
- BB 폭이 1~10% 범위인가?
- 쿨다운이 끝났는가?
- ATR이 안정적인가?

### 문제 5: NaN 에러
**원인**: 데이터 부족 또는 계산 오류
**해결**: ✅ 이미 수정됨 (분모=0 방어 추가)

---

## ✅ 테스트 체크리스트

- [ ] Upbit API 키 발급 완료
- [ ] `.env` 파일 설정 완료
- [ ] 계좌에 5,000원 입금 완료
- [ ] 봇 실행 및 로그 확인
- [ ] 1시간 정도 관찰 (거래 발생 여부)
- [ ] 수동으로 중단 (Ctrl+C)
- [ ] 로그 파일 확인
- [ ] 업비트에서 거래 내역 확인

---

## 📝 개선된 알고리즘 요약

| 문제 | 수정 내용 |
|------|-----------|
| ATR 미사용 | ✅ 레짐 판별에 ATR 통합, 변동성 급증 감지 |
| Import 오류 | ✅ 이미 통합 모듈로 존재함 |
| NaN 에러 | ✅ 모든 분모=0 경우 방어 추가 |
| 중간 ADX 애매 | ✅ ATR 기반 추세 전환 감지 |
| 변동성 필터 없음 | ✅ BB 폭 제한 + 쿨다운 추가 |

**이제 실제 돈으로 안전하게 테스트할 수 있습니다!** 🚀
